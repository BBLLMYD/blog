<br>

TCP/IP协议的用途不用多说，是绝大多数应用采用的基础协议，
因为TCP/IP的特性是可靠传输。但是协议的本质毕竟是规范，
真正完成协议所规范内容的还是需要硬件和操作系统支持。
并且网络环境有太多的不可控，丢包、乱序、重传、拥塞现象常见，
既然是承诺可靠的协议，针对以上现象就都需要作出相应的算法策略来保障可靠性。

> TCP/IP传输协议，即传输控制/网络协议，也叫作网络通讯协议。它是在网络的使用中的最基本的通信协议。TCP/IP传输协议对互联网中各部分进行通信的标准和方法进行了规定。并且，TCP/IP传输协议是保证网络数据信息及时、完整传输的两个重要的协议。TCP/IP传输协议是严格来说是一个四层的体系结构，应用层、传输层、网络层和数据链路层都包含其中。

### 长链接下出现粘包/拆包的原因和应对方案

上面说到对于丢包、乱序等现象TCP本身有算法来保障数据正确传输，
但是当我们基于TCP做上层应用时，还是有一些问题是需要在应用层做保障的，
比如长连接下的粘包拆包现象，TCP保证了数据在传输层的可靠性，
但是这些字节数据在TCP层面是无状态的，由于TCP的缓冲区机制可能导致应用层收到了半包或者粘包的数据。

因为TCP是面向字节流的协议，"流"本身可以看作是无状态、保证传输的时序顺序的不间断无逻辑边界的字节数据。
和UDP对比来看，TCP有缓冲区，而UDP面向报文段是没有缓冲区的。
TCP发送报文时，是将应用层数据写入TCP缓冲区中，然后由TCP协议来控制发送这里面的数据，
而发送的状态是按字节流的方式发送的，**跟应用层写下来的报文长度没有任何关系**，所以说是流。
而UDP没有缓冲区，应用层写的报文数据会直接加包头交给网络层，由网络层负责分片，所以说是面向报文段的。

上面说到和应用层写下来的报文长度关系，也就是传输层此时一定程度上是不关注或者说不负责检查应用层写的数据内容和大小，
这些数据在传输层都是无差别的无状态的字节流。
那么在基于TCP传输的长链接场景，比如在应用程序写入的数据大于套接字缓冲区大小时，将会发生拆包现象；
应用程序写入数据小于套接字缓冲区大小，网卡将应用多次写入的数据发送到网络上时将会发生粘包现象等。
总的来看可以说既有由于操作系统和硬件的工作机制导致、也可能有协议本身的机制限制导致发生，
因为这数据粘连的影响是在应用层才能体现的。也就需要在应用层面上来解决粘包拆包带来的问题。

- 从收发的角度：一个发送被多次接受（拆），多次发送被一次接受（粘）。
- 从传输的角度：一个发送占用多个传输包（拆），多个发送共用一个传输包（粘）。
                                            
<div align=center><img src="https://github.com/BBLLMYD/blog/blob/master/images/09/0901.png?raw=true" width="798"></div>

对于粘包拆包的原因如果理解了的话，其实不难想出在应用层应对这种现象的方法，往往也是一些通用的思想。
包括：发送方面和接受方约定固定的长度；约定指定分隔符；固定的位置用来存取存储报文长度等，他们优劣势在上图中也有说明。
 
### 从TCP头包含的信息来看TCP协议一些机制实现

我们知道应用数据到发送到传输层的时候，会被增加一部分TCP头信息，为什么是这些数据，
上面提到了TCP需要在恶劣不可靠的环境下保证数据的可靠传输，
那么这部分头部信息包含的内容是如何被协议利用的呢。

<div align=center><img src="https://github.com/BBLLMYD/blog/blob/master/images/09/0902.png?raw=true" width="798"></div>

上图中数据上面的部分都是TCP的头部信息。
从上往下看，源端口号目标端口号，由于传输层是不关注ip信息的，ip信息在下面的ip层添加，
**在添加了一层ip信息之后源ip+源端口+目的ip+目的端口就可以视为一个"TCP元组"，可以确定唯一的一条TCP连接了**。

序列号和确认序号就是发送过程中的seq和ack的值，**需要和FLAG配合才能表示出准确的意义**，
在确认成功发送的同时序号的值也保证着包的顺序逻辑，避免乱序。

头部长度的字段是用来数据部分开始的位置的，因为头部可能也存在一些扩展字段信息，所以按照固定长度来计算会很大程度上降低灵活性。

上面提到的序列号和确认序号需要和FLAG配合，**这里的FLAG其实就是六个状态（6个bit），
当值为1的时候表示有效状态**，常规下SYN表示建立连接的同步信号；ACK用于对收到的数据进行确认；FIN通常用于发起断开连接；PSH表示有数据传输；RST表示连接重置；URG是紧急位为1的时候表示紧急指针有效；
**其中SYN、ACK、FIN的意义是重点，因为在TCP的连接状态下，
他们的标志往往决定了Client端和Server端的状态，
这些状态需要占用着系统的文件句柄资源，在大量连接下这些也是影响着系统吞吐量和性能，以及应用传输数据期间是否是健康的状态重点参考的部分。**

**窗口尺寸是为了动态的适应和平衡发送和接收方的处理能力**，做出合理的流量控制，避免发的太快造成拥堵，发的太慢造成饥饿。

<br>



