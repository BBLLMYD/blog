<br>

在计算机软件领域中负载的概念，
在宏观上可以看做是一种解决高性能，单点故障（高可用），扩展性（水平伸缩）的解决方案，
将负载（包括工作任务，访问请求）进行平衡、分摊到多个操作单元（服务器，组件）上进行执行。
常见专用的负载均衡组件如软件上的nginx代理服务器、偏硬件的F5负载均衡器等，就是为了让我们的服务在软件层面上达到一个"负载均衡"的状态。

负载均衡在维基百科词条中的部分描述
> 负载平衡（Load balancing）是一种计算机技术，用来在多个计算机（计算机集群）、网络连接、CPU、磁盘驱动器或其他资源中分配负载，以达到最优化资源使用、最大化吞吐率、最小化响应时间、同时避免过载的目的。 使用带有负载平衡的多个服务器组件，取代单一的组件，可以通过冗余提高可靠性。负载平衡服务通常是由专用软件和硬件来完成。 主要作用是将大量作业合理地分摊到多个操作单元上进行执行，用于解决互联网架构中的高并发和高可用的问题。

从微观上看，计算机操作系统中的对网络连接、CPU等资源的分配策略，
往往也影响着吞吐率和对资源的利用率是否合理，同时也是意味着应用服务或系统是否过载。
**负载是一个抽象的概念，在我们常见的分布式业务系统或中间件中很多方面都有面对着"过载"状况的策略，
操作系统、网络以及容器编排器等也都有各自的负载均衡技术，用于使用各自的资源进行各自的任务调度。**

有的时候由于业务上一些天然的[局部性特征](https://github.com/BBLLMYD/blog/blob/master/blogs/%E6%8A%BD%E8%B1%A1%E4%B9%8B%E4%BA%8E%E2%80%9C%E5%B1%80%E9%83%A8%E6%80%A7%E5%8E%9F%E7%90%86%E2%80%9D.md)，
比如秒杀中的热点商品等场景，也可能会由于数据特征可能会导致流量的不均衡，
进而相关组件的负载均衡的策略算法的采用如果不适合的话，可能会导致一些数据倾斜等问题，
影响系统的吞吐率和资源利用率，严重情况甚至会影响服务的可用性。

这篇我们主要从下面几个角度，在不同的上下文中来分别讨论一下"负载"

1.[操作系统负载]()
2.[网络负载均衡]()
3.[流量骤增下的负载]()
4.[中间件的负载均衡]()
5.[负载均衡算法]()

* * * 

### 1.操作系统负载

操作系统的"过载"通常是由其上游的用户进程对有限资源的使用过度导致的，
当"过载"发生时，往往会导致应用程序卡顿变慢甚至停止运行。
一般根据用户程序工作偏重的类型不同，吃的主要资源也不同。
**CPU密集型应用往往都是大量计算类的程序，如高清视频解码、数学建模、加解密等，
瓶颈基本都是出现在CPU的吞吐率。**
Linux服务器下的CPU负载率可以通过uptime/top来查看，
但是load average的负载值所能表示的含义需要结合CPU的核数来看（cat /proc/cpuinfo），
单核的负载load average经验值认为低于0.7时是安全合理的；load average接近1表明CPU在全力运转；
当load average大于4时CPU运行效率已经很低，**此时大量的CPU会大量浪费在进程切换这种系统的内耗上**，需要及时处理。
现在基本都是多核的服务器，几核就按照上述单核状况下的数值乘以对应的核数作为参考。

实际上现在的load average 并非指完全指代cpu load average，
而是system load average。包含一些I/O或者lock的wait情况的统计，
而在CPU密集的计算型应用中这些额外数据的占比是基本可以忽略的。

而在IO密集型的应用中，通过load average数据就不足以判断负载情况了，
因为IO密集型的应用场景也特性较多，
各种长短链接、连接池、高并发低并发、大块数据传输等场景，
也是大多数后台（eg:Web应用）程序属于的类型。**此时要关注的资源不再单局限于CPU的吞吐，
CPU Loading并不高是因为CPU可能在很多时间在等I/O (硬盘/内存) 的读/写操作**。
更多的如网络IO、磁盘IO、应用程序的线程资源、操作系统的文件句柄等资源的紧张会导致系统出现瓶颈。
关于以TCP协议为通信基础的服务程序相关可以看一下[另一篇讨论]()。
对于涉及大量数据存取的中间件如mysql、mq、hbase等，
磁盘IO常会成为系统瓶颈，自然也就成了一个重要的优化方向。
````
// iostat工具可以查看系统IO相关指标
iostat
````
需要重点关注的指标字段：tps(磁盘每秒请求多少次IO操作)、avgqu-sz（IO队列的平均长度）、await（平均每一个IO花费了多少毫秒）、%util（磁盘的负荷程度，和磁盘个数正比 类似cpu load average参考方式）
相关的检测命令工具还有如vmstat、sar -b、iotop等。

影响磁盘IO的因素其实比较多，结合操作系统系统层面上如硬盘硬件的类型（ssd和hdd）和操作系统中的IO调度算法再结合应用程序读写特征，去配置适合的组合、以及文件系统缓存的优化等方向。
比如mysql系统，如果是SSD磁盘，那么应该指定NOOP调度算法，如果是磁盘，就更适用Deadline调度算法
CFQ：一般系统下默认的IO调度算法，但却不是适合的，数据库进程基本是IO最多的一个进程组，但却只能获得和其它进程一样多的IO调度机会。
Deadline: 按照截止期限来循环在各个IO队列中进行调度，所以它提供了一个近实时的IO系统，并且磁盘throughput也比较和，通常在hdd下比较适合。
NOOP：该调度算法特别适合于SSD。因为SSD在对待顺序IO和随机IO没有什么区别。所以它不需要对临近的IO进行合并。避免了合并操作对CPU的使用。
````
// 查看系统IO调度方法
cat /sys/block/sda/queue/scheduler
// 在文件/boot/grub/menu.lst下修改指定方法
````

<br>



