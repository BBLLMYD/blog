<br>

"幂等"在网络词条中有下面的描述：
  
  
> 百度百科：<br>
  幂等是一个数学与计算机学概念，常见于抽象代数中。在编程中一个幂等操作的特点是其任意多次执行所产生的影响均与一次执行的影响相同。<br>
  幂等函数，或幂等方法，是指可以使用相同参数重复执行，并能获得相同结果的函数。这些函数不会影响系统状态，也不用担心重复执行会对系统造成改变。例如，“setTrue()”函数就是一个幂等函数,无论多次执行，其结果都是一样的。

> 维基百科：<br>
  在面向服务的体系结构（SOA）中，如果流程的任何部分失败，则可以重播完全由幂等步骤组成的多步骤编排流程，而不会产生副作用。

业务系统在分布式环境中，必然存在大量的网络调用，在写入数据系统节点的业务逻辑中，也一定会存在关于幂等的处理。
不管是来自上游的同步的网络调用，还是异步的消息消费，都存在是相同请求重复处理的可能性。此时幂等性设计的好坏既要保证数据的正确性也影响着整体程序的性能。

幂等性：满足f(x) = f(f(x))

处理幂等请求有很多实践方案，如幂等表方案、乐观锁（version版本号字段，状态机单向流转）方案、分布式锁方案等，解决重复执行的副作用是幂等要解决的核心问题，下面分别从两个角度出发尝试更清晰的讨论对于幂等的处理方法。

- [1.处理幂等请求步骤次序]()
- [2.不同数据操作下对于幂等请求的处理方案]()

* * *

### 1.处理幂等请求步骤次序

不管是哪一种方案，处理幂等请求的大体步骤都是一样的。

- 1：**识别相同的重复请求**

    当整体逻辑兼容了幂等请求时候，这一步的识别动作可能并不是必要的，识别重复请求通常在insert数据时比较必要。
    
- 2：找到重复请求可能会产生的副作用并解决

    如果是插入数据要确认是不是要避免重复提交；更新数据状态/量值要确认是不是已经更新过。
    
- 3：确定对于重复请求针对上层的响应模式

    需要考虑是不是显示给上游响应本次的请求已经成功处理并且是重复请求，需要和业务协定。


* * *

### 2.不同数据操作下对于幂等请求的处理方案

通常来说select操作具有天然幂等的特性；
对于delete来说对于定位数据逻辑相关，绝对定位的方式通常不会出现问题，
一般的删除动作也是做逻辑删除，实际上也是update操作。
对于update操作情况就比较多一些，下面就是两种不同结果的示例。

- 1：数据查询操作
- 1：数据插入操作

```

/* 幂等操作（能保证数据正确性，但需要注意处理幂等请求的时候返回的影响行数不一致）*/
update table_x set del=1 where id= 110;

// 非幂等
update table_x set num = num-1 where id= 110;

```

考虑到幂等的处理，或多或少都会对业务有一点侵入型，对于后端处理幂等请求的成本和程序性能，
实际应用前端通常会挡住或者避免大部分的幂等请求，
但是后端的服务并不能第一点抱着一个全盘信任上游的态度，第二点对于网络的不可靠是个长久的主题，
更何况无法保证上游是不是有超时重试的机制，又或是重复消息情况。







